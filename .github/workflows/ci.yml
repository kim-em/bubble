name: CI

on:
  push:
    branches: [main, master]
  pull_request:

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install ruff
      - run: ruff check lean_bubbles/ tests/
      - run: ruff format --check lean_bubbles/ tests/

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - run: pip install -e ".[dev]"
      - run: pytest -v -m "not integration"

  integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Incus
        run: |
          sudo mkdir -p /etc/apt/keyrings/
          curl -fsSL https://pkgs.zabbly.com/key.asc | sudo tee /etc/apt/keyrings/zabbly.asc > /dev/null
          sudo sh -c 'cat <<EOF > /etc/apt/sources.list.d/zabbly-incus-stable.sources
          Enabled: yes
          Types: deb
          URIs: https://pkgs.zabbly.com/incus/stable
          Suites: $(. /etc/os-release && echo ${VERSION_CODENAME})
          Components: main
          Architectures: $(dpkg --print-architecture)
          Signed-By: /etc/apt/keyrings/zabbly.asc
          EOF'
          sudo apt-get update
          sudo apt-get install -y incus

      - name: Initialize Incus
        run: |
          sudo incus admin init --minimal
          # Allow non-root access (CI-only, ephemeral VM)
          sudo chmod 666 /var/lib/incus/unix.socket
          # Ensure IP forwarding and NAT for container internet access
          sudo sysctl -w net.ipv4.ip_forward=1
          sudo iptables -t nat -A POSTROUTING -s 10.0.0.0/8 -o eth0 -j MASQUERADE
          sudo iptables -A FORWARD -i incusbr0 -j ACCEPT
          sudo iptables -A FORWARD -o incusbr0 -m state --state RELATED,ESTABLISHED -j ACCEPT

      - name: Install lean-bubbles
        run: pip install -e ".[dev]"

      - name: Build lean-base image
        run: bubble images build lean-base

      - name: Run integration tests
        run: pytest -v -m integration
